{
  "db_name": "PostgreSQL",
  "query": "\n        WITH active_tenants AS (\n          SELECT id, tokens FROM tenants\n          WHERE tokens > 0\n          FOR UPDATE SKIP LOCKED\n        ),\n        candidate_ids AS (\n          SELECT job_lat.*\n          FROM active_tenants t\n          CROSS JOIN LATERAL (\n            SELECT\n              job.id,\n              job.scheduled_at\n            FROM scheduled_jobs job\n            WHERE job.tenant_id = t.id\n              AND job.lock_nonce IS NULL\n              AND job.execution_id IS NULL\n              AND (\n                (job.region = $1 AND job.scheduled_at <= now() + interval '3 seconds')\n                OR (job.scheduled_at <= now() - interval '5 seconds')\n              )\n            ORDER BY job.scheduled_at ASC, job.id ASC\n            LIMIT t.tokens\n          ) job_lat\n          UNION ALL\n          SELECT id, scheduled_at\n          FROM scheduled_jobs\n          WHERE tenant_id IS NULL\n            AND lock_nonce IS NULL\n            AND execution_id IS NULL\n            AND (\n              (region = $1 AND scheduled_at <= now() + interval '3 seconds')\n              OR (scheduled_At <= now() - interval '5 seconds')\n            )\n          ORDER BY scheduled_at ASC, id ASC\n          LIMIT 100\n        ),\n        jobs_to_lock AS (\n          SELECT id FROM scheduled_jobs\n          WHERE id IN (SELECT id FROM candidate_ids)\n          FOR UPDATE SKIP LOCKED\n        ),\n        updated_jobs AS (\n          UPDATE scheduled_jobs\n          SET\n            lock_nonce = extract(epoch from now()),\n            times_locked = times_locked + 1\n          WHERE id IN (SELECT id FROM jobs_to_lock)\n          RETURNING id, tenant_id\n        ),\n        updated_tenants AS (\n          UPDATE tenants tenant\n          SET tokens = GREATEST(0, tokens - sub.used_tokens)\n          FROM (\n            SELECT tenant_id, count(*) AS used_tokens\n            FROM updated_jobs\n            WHERE tenant_id IS NOT NULL\n            GROUP BY tenant_id\n          ) sub\n          WHERE tenant.id = sub.tenant_id\n          RETURNING tenant.id\n        )\n        SELECT\n          job.id as job_id,\n          job.lock_nonce,\n          job.scheduled_at,\n          job.timeout_ms,\n          job.max_response_bytes,\n          tenant.id as \"tenant_id?\",\n          tenant.max_timeout as \"max_timeout?\",\n          tenant.max_max_response_bytes as \"max_max_response_bytes?\",\n          secret.id as \"secret_id?\",\n          secret.master_key_id as \"master_key_id?\",\n          secret.secret_version as \"secret_version?\",\n          secret.encrypted_dek as \"encrypted_dek?\",\n          secret.encrypted_data as \"encrypted_data?\",\n          secret.dek_nonce as \"dek_nonce?\",\n          secret.data_nonce as \"data_nonce?\",\n          secret.algorithm as \"algorithm?\",\n          req.method,\n          req.url,\n          req.headers,\n          req.body\n        FROM scheduled_jobs job\n        JOIN updated_jobs\n          ON updated_jobs.id = job.id\n        JOIN http_requests AS req\n          ON req.id = job.request_id\n        LEFT JOIN tenants tenant\n          ON tenant.id = job.tenant_id\n        LEFT JOIN secrets secret\n          ON secret.id = tenant.current_signing_key\n        ORDER BY job.scheduled_at ASC;\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "job_id",
        "type_info": "Varchar"
      },
      {
        "ordinal": 1,
        "name": "lock_nonce",
        "type_info": "Int4"
      },
      {
        "ordinal": 2,
        "name": "scheduled_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 3,
        "name": "timeout_ms",
        "type_info": "Int4"
      },
      {
        "ordinal": 4,
        "name": "max_response_bytes",
        "type_info": "Int4"
      },
      {
        "ordinal": 5,
        "name": "tenant_id?",
        "type_info": "Varchar"
      },
      {
        "ordinal": 6,
        "name": "max_timeout?",
        "type_info": "Int4"
      },
      {
        "ordinal": 7,
        "name": "max_max_response_bytes?",
        "type_info": "Int4"
      },
      {
        "ordinal": 8,
        "name": "secret_id?",
        "type_info": "Varchar"
      },
      {
        "ordinal": 9,
        "name": "master_key_id?",
        "type_info": "Int4"
      },
      {
        "ordinal": 10,
        "name": "secret_version?",
        "type_info": "Int4"
      },
      {
        "ordinal": 11,
        "name": "encrypted_dek?",
        "type_info": "Bytea"
      },
      {
        "ordinal": 12,
        "name": "encrypted_data?",
        "type_info": "Bytea"
      },
      {
        "ordinal": 13,
        "name": "dek_nonce?",
        "type_info": "Bytea"
      },
      {
        "ordinal": 14,
        "name": "data_nonce?",
        "type_info": "Bytea"
      },
      {
        "ordinal": 15,
        "name": "algorithm?",
        "type_info": "Text"
      },
      {
        "ordinal": 16,
        "name": "method",
        "type_info": "Varchar"
      },
      {
        "ordinal": 17,
        "name": "url",
        "type_info": "Text"
      },
      {
        "ordinal": 18,
        "name": "headers",
        "type_info": "TextArray"
      },
      {
        "ordinal": 19,
        "name": "body",
        "type_info": "Text"
      }
    ],
    "parameters": {
      "Left": [
        "Text"
      ]
    },
    "nullable": [
      false,
      true,
      false,
      true,
      true,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      false,
      true
    ]
  },
  "hash": "e4eec8a51246a8b6610594a005ac2a08aaa6257114288dc2fac8612f712641ff"
}
