name: Tag on Cargo Version Change

run-name: Tag on Cargo Version Change - ${{ github.event.head_commit.message }}

on:
  push:
    branches:
      - master
    paths:
      - "Cargo.toml"

jobs:
  tag-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version from Cargo.toml
        id: cargo
        run: |
          version=$(grep '^version' Cargo.toml | head -n1 | awk -F\" '{print $2}')
          echo "cargo_version=$version" >> $GITHUB_ENV

      - name: Compare Cargo.toml version
        id: compare
        run: |
          git fetch origin master
          prev_version=$(git show origin/master:Cargo.toml | grep '^version' | head -n1 | awk -F\" '{print $2}')
          curr_version=$(grep '^version' Cargo.toml | head -n1 | awk -F\" '{print $2}')

          echo "Previous version: $prev_version"
          echo "Current version: $curr_version"

          if [ "$curr_version" = "$prev_version" ]; then
            echo "Version has not changed."
            exit 0
          fi

          echo "Version changed. Tagging v$curr_version"
          echo "cargo_version=$curr_version" >> $GITHUB_ENV

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$cargo_version" -m "Release v$cargo_version"
          git push origin "v$cargo_version"
